<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Remitos ‚Üí Excel ¬∑ AI</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --bg: #0d0f14;
    --surface: #161920;
    --surface2: #1e2230;
    --border: #2a2f40;
    --accent: #10a37f;
    --accent2: #1ad6a4;
    --danger: #ef4444;
    --danger-soft: #2d1515;
    --text: #e2e8f0;
    --text-muted: #64748b;
    --text-dim: #94a3b8;
    --green: #22c55e;
    --green-soft: #0f2d1a;
    --radius: 10px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Syne', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: linear-gradient(rgba(16,163,127,0.04) 1px, transparent 1px), linear-gradient(90deg, rgba(16,163,127,0.04) 1px, transparent 1px);
    background-size: 40px 40px; pointer-events: none; z-index: 0;
  }
  .container { max-width: 1020px; margin: 0 auto; padding: 40px 24px 80px; position: relative; z-index: 1; }

  header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 40px; flex-wrap: wrap; gap: 16px; }
  .logo-area h1 { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; }
  .logo-area h1 span { color: var(--accent2); }
  .logo-area p { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-muted); margin-top: 6px; letter-spacing: 0.05em; text-transform: uppercase; }
  .badge { font-family: 'DM Mono', monospace; font-size: 10px; background: rgba(16,163,127,0.12); color: var(--accent2); border: 1px solid rgba(16,163,127,0.3); padding: 4px 10px; border-radius: 20px; letter-spacing: 0.05em; align-self: flex-start; }

  .section { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 28px; margin-bottom: 20px; }
  .section-title { font-size: 11px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
  .section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  .api-row { display: flex; gap: 10px; }
  .api-row input { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 13px; padding: 10px 14px; outline: none; transition: border-color 0.15s; }
  .api-row input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(16,163,127,0.1); }
  .api-note { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-muted); margin-top: 8px; }
  .api-note a { color: var(--accent2); text-decoration: none; }
  .api-note a:hover { text-decoration: underline; }

  /* PDF mode notice */
  .notice { background: rgba(16,163,127,0.07); border: 1px solid rgba(16,163,127,0.2); border-radius: 8px; padding: 12px 16px; font-family: 'DM Mono', monospace; font-size: 11px; color: var(--accent2); margin-bottom: 16px; line-height: 1.6; }
  .notice strong { color: var(--text-dim); }

  .dropzone { border: 2px dashed var(--border); border-radius: var(--radius); padding: 48px 24px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; }
  .dropzone:hover, .dropzone.drag { border-color: var(--accent); background: rgba(16,163,127,0.03); }
  .dropzone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
  .dropzone-icon { font-size: 36px; margin-bottom: 12px; }
  .dropzone h3 { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
  .dropzone p { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-muted); }
  .file-selected { border-color: var(--green) !important; background: var(--green-soft) !important; }

  .analyze-wrap { display: flex; justify-content: center; margin-top: 20px; }

  .status-bar { display: none; align-items: center; gap: 12px; padding: 14px 18px; border-radius: 8px; font-family: 'DM Mono', monospace; font-size: 12px; margin-top: 16px; }
  .status-bar.loading { background: rgba(16,163,127,0.08); border: 1px solid rgba(16,163,127,0.2); color: var(--accent2); display: flex; }
  .status-bar.success { background: var(--green-soft); border: 1px solid rgba(34,197,94,0.25); color: var(--green); display: flex; }
  .status-bar.error { background: var(--danger-soft); border: 1px solid rgba(239,68,68,0.25); color: var(--danger); display: flex; }
  .spinner { width: 14px; height: 14px; border: 2px solid rgba(16,163,127,0.3); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; flex-shrink: 0; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group label { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-muted); letter-spacing: 0.05em; text-transform: uppercase; }
  .form-group input { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 13px; padding: 10px 14px; outline: none; transition: border-color 0.15s; width: 100%; }
  .form-group input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(16,163,127,0.1); }
  .form-group input::placeholder { color: var(--text-muted); }

  .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead th { background: var(--surface2); font-family: 'DM Mono', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); padding: 12px 14px; text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap; }
  tbody tr { border-bottom: 1px solid rgba(42,47,64,0.6); transition: background 0.1s; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: rgba(255,255,255,0.02); }
  tbody td { padding: 4px 6px; vertical-align: middle; }
  tbody td input { background: transparent; border: 1px solid transparent; border-radius: 5px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 12px; padding: 7px 10px; width: 100%; outline: none; transition: all 0.15s; }
  tbody td input:focus { background: var(--surface2); border-color: var(--accent); }
  tbody td input.repeated { color: var(--danger); font-weight: 500; }
  .repeated-tag { font-family: 'DM Mono', monospace; font-size: 9px; background: var(--danger-soft); color: var(--danger); border: 1px solid rgba(239,68,68,0.3); padding: 2px 6px; border-radius: 20px; margin-left: 4px; white-space: nowrap; }
  .btn-remove { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; padding: 6px 10px; border-radius: 5px; transition: all 0.15s; line-height: 1; }
  .btn-remove:hover { color: var(--danger); background: var(--danger-soft); }

  .actions { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px; align-items: center; }
  .btn { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; padding: 11px 22px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 8px; letter-spacing: 0.02em; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover:not(:disabled) { background: #0d8f6f; transform: translateY(-1px); box-shadow: 0 4px 20px rgba(16,163,127,0.35); }
  .btn-secondary { background: var(--surface2); color: var(--text-dim); border: 1px solid var(--border); }
  .btn-secondary:hover:not(:disabled) { border-color: var(--accent); color: var(--accent2); }
  .btn-ghost { background: none; color: var(--text-muted); border: 1px dashed var(--border); }
  .btn-ghost:hover:not(:disabled) { border-color: var(--accent); color: var(--accent2); background: rgba(16,163,127,0.05); }
  .btn-export { background: #3b82f6; color: #fff; font-weight: 800; }
  .btn-export:hover:not(:disabled) { background: #2563eb; transform: translateY(-1px); box-shadow: 0 4px 20px rgba(59,130,246,0.35); }

  .info-bar { display: flex; gap: 24px; flex-wrap: wrap; font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-muted); margin-top: 12px; }
  .info-bar span { display: flex; align-items: center; gap: 6px; }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); display: inline-block; }
  .dot.warn { background: var(--danger); }

  #toast { position: fixed; bottom: 32px; right: 32px; background: #3b82f6; color: #fff; font-family: 'DM Mono', monospace; font-size: 12px; font-weight: 500; padding: 12px 20px; border-radius: 8px; opacity: 0; transform: translateY(10px); transition: all 0.3s; z-index: 999; pointer-events: none; }
  #toast.show { opacity: 1; transform: translateY(0); }

  @media (max-width: 600px) {
    .form-row { grid-template-columns: 1fr; }
    .actions { flex-direction: column; }
    .btn { width: 100%; justify-content: center; }
    .api-row { flex-direction: column; }
  }
</style>
</head>
<body>
<div class="container">

  <header>
    <div class="logo-area">
      <h1>Remitos ‚Üí <span>Excel</span> ¬∑ AI</h1>
      <p>Carg√° un PDF ¬∑ GPT-4o lo analiza ¬∑ Descarg√° el .xlsx</p>
    </div>
    <div class="badge">POWERED BY OPENAI</div>
  </header>

  <!-- API Key -->
  <div class="section">
    <div class="section-title">API Key de OpenAI</div>
    <div class="api-row">
      <input type="password" id="apiKey" placeholder="sk-..." autocomplete="off">
    </div>
    <p class="api-note">
      Tu clave nunca sale de tu navegador ¬∑ Conseguila en
      <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a>
      ¬∑ Costo: ~$0.01 por remito
    </p>
  </div>

  <!-- Upload -->
  <div class="section">
    <div class="section-title">Cargar Documento</div>
    <div class="notice">
      <strong>üìé PDF o imagen:</strong> Pod√©s subir el PDF directamente o una foto/captura del remito. GPT-4o mini analiza ambos formatos.
    </div>
    <div class="dropzone" id="dropzone">
      <input type="file" accept=".pdf,image/*" id="fileInput" onchange="onFileSelected(this)">
      <div class="dropzone-icon" id="dzIcon">üìÑ</div>
      <h3 id="dropTitle">Arrastr√° el PDF o hac√© click</h3>
      <p id="dropSub">PDF e im√°genes ¬∑ Remito o Confirmaci√≥n de pedido</p>
    </div>
    <div class="analyze-wrap">
      <button class="btn btn-primary" id="btnAnalyze" onclick="analyzeDocument()" disabled>
        ‚ú¶ Analizar con GPT-4o
      </button>
    </div>
    <div class="status-bar" id="statusBar">
      <div class="spinner" id="statusSpinner"></div>
      <span id="statusText"></span>
    </div>
  </div>

  <!-- Datos -->
  <div class="section">
    <div class="section-title">Datos del Documento</div>
    <div class="form-row">
      <div class="form-group">
        <label>N√∫mero de Remito / Pedido</label>
        <input id="nroRemito" type="text" placeholder="0044-00167431">
      </div>
      <div class="form-group">
        <label>Fecha</label>
        <input id="fecha" type="date">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Cliente</label>
        <input id="cliente" type="text" placeholder="BAGNOLS S.A.">
      </div>
      <div class="form-group">
        <label>N¬∞ Pedido Cliente</label>
        <input id="nroPedido" type="text" placeholder="I 133/25-RAMSAY">
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="section">
    <div class="section-title">√çtems</div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th style="width:80px">Item</th>
            <th style="width:160px">Referencia</th>
            <th>Descripci√≥n</th>
            <th style="width:90px">Cantidad</th>
            <th style="width:40px"></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="actions">
      <button class="btn btn-ghost" onclick="addRow()">Ôºã Agregar fila</button>
      <button class="btn btn-secondary" onclick="clearAll()">‚úï Limpiar</button>
    </div>
    <div class="info-bar" id="infoBar"></div>
  </div>

  <div class="actions">
    <button class="btn btn-export" onclick="exportExcel()">‚Üì Descargar Excel</button>
  </div>

</div>
<div id="toast">‚úì Excel generado correctamente</div>

<script>
let rowId = 0;
let selectedFile = null;

// ‚îÄ‚îÄ File selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onFileSelected(input) {
  const file = input.files[0];
  if (!file) return;
  selectedFile = file;
  document.getElementById('dropzone').classList.add('file-selected');
  document.getElementById('dzIcon').textContent = '‚úÖ';
  document.getElementById('dropTitle').textContent = file.name;
  document.getElementById('dropSub').textContent = `${(file.size/1024).toFixed(1)} KB ¬∑ listo para analizar`;
  document.getElementById('btnAnalyze').disabled = false;
}

const dz = document.getElementById('dropzone');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag'); });
dz.addEventListener('dragleave', () => dz.classList.remove('drag'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('drag');
  const file = e.dataTransfer.files[0];
  if (!file) return;
  const dt = new DataTransfer(); dt.items.add(file);
  document.getElementById('fileInput').files = dt.files;
  onFileSelected(document.getElementById('fileInput'));
});

// ‚îÄ‚îÄ Analyze with OpenAI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function analyzeDocument() {
  const apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) { showStatus('error', '‚ö† Ingres√° tu API Key de OpenAI primero.'); return; }
  if (!selectedFile) { showStatus('error', '‚ö† Seleccion√° un archivo primero.'); return; }

  showStatus('loading', 'Leyendo archivo...');
  document.getElementById('btnAnalyze').disabled = true;

  try {
    const isPDF = selectedFile.type === 'application/pdf';
    const base64 = await fileToBase64(selectedFile);

    showStatus('loading', 'Enviando a GPT-4o mini...');

    const prompt = `Analiz√° este documento (remito o confirmaci√≥n de pedido).
Extra√©:
1. N√∫mero de remito o pedido
2. Fecha (formato YYYY-MM-DD)
3. Nombre del cliente
4. N√∫mero de pedido del cliente (si existe)
5. Todos los √≠tems con: Item, Referencia, Descripci√≥n, Cantidad

Respond√© √öNICAMENTE con JSON v√°lido, sin texto extra ni markdown:
{
  "nroRemito": "...",
  "fecha": "YYYY-MM-DD",
  "cliente": "...",
  "nroPedido": "...",
  "items": [
    { "item": "10", "ref": "A9F74310", "desc": "INT. TERMOMAG. IC60N 3X10A", "cant": 30 }
  ]
}`;

    let messages;
    if (isPDF) {
      // PDFs via file upload + responses API approach:
      // For simplicity, convert first page to image approach isn't available in browser.
      // We send as base64 URL with application/pdf - GPT-4o supports this.
      messages = [{
        role: 'user',
        content: [
          {
            type: 'file',
            file: {
              filename: selectedFile.name,
              file_data: `data:application/pdf;base64,${base64}`
            }
          },
          { type: 'text', text: prompt }
        ]
      }];
    } else {
      // Image
      messages = [{
        role: 'user',
        content: [
          {
            type: 'image_url',
            image_url: { url: `data:${selectedFile.type};base64,${base64}`, detail: 'high' }
          },
          { type: 'text', text: prompt }
        ]
      }];
    }

    const res = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        max_tokens: 2000,
        messages
      })
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error?.message || `HTTP ${res.status}`);
    }

    const data = await res.json();
    const text = data.choices?.[0]?.message?.content || '';
    const clean = text.replace(/```json|```/g, '').trim();
    const parsed = JSON.parse(clean);

    if (parsed.nroRemito) document.getElementById('nroRemito').value = parsed.nroRemito;
    if (parsed.fecha)     document.getElementById('fecha').value = parsed.fecha;
    if (parsed.cliente)   document.getElementById('cliente').value = parsed.cliente;
    if (parsed.nroPedido) document.getElementById('nroPedido').value = parsed.nroPedido;

    document.getElementById('tbody').innerHTML = '';
    rowId = 0;
    (parsed.items || []).forEach(item => addRow(item));

    showStatus('success', `‚úì ${parsed.items?.length || 0} √≠tems extra√≠dos correctamente`);
  } catch(err) {
    showStatus('error', `‚úó ${err.message}`);
    console.error(err);
  } finally {
    document.getElementById('btnAnalyze').disabled = false;
  }
}

function fileToBase64(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(r.result.split(',')[1]);
    r.onerror = () => rej(new Error('Error leyendo el archivo'));
    r.readAsDataURL(file);
  });
}

function showStatus(type, msg) {
  const bar = document.getElementById('statusBar');
  bar.className = `status-bar ${type}`;
  document.getElementById('statusSpinner').style.display = type === 'loading' ? 'block' : 'none';
  document.getElementById('statusText').textContent = msg;
}

// ‚îÄ‚îÄ Table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getRepeated() {
  const count = {};
  document.querySelectorAll('.col-ref').forEach(i => {
    const v = i.value.trim().toUpperCase();
    if (v) count[v] = (count[v] || 0) + 1;
  });
  return new Set(Object.keys(count).filter(k => count[k] > 1));
}

function addRow(data = {}) {
  const id = rowId++;
  const tr = document.createElement('tr');
  tr.dataset.id = id;
  tr.innerHTML = `
    <td><input class="col-item" placeholder="10" value="${data.item ?? ''}"></td>
    <td style="white-space:nowrap">
      <input class="col-ref" placeholder="REF" value="${data.ref ?? ''}" oninput="updateUI()">
      <span class="repeated-tag" style="display:none"></span>
    </td>
    <td><input class="col-desc" placeholder="Descripci√≥n" value="${data.desc ?? ''}"></td>
    <td><input class="col-cant" type="number" min="0" placeholder="1" value="${data.cant ?? ''}"></td>
    <td><button class="btn-remove" onclick="removeRow(${id})">√ó</button></td>
  `;
  document.getElementById('tbody').appendChild(tr);
  updateUI();
}

function removeRow(id) {
  document.querySelector(`tr[data-id="${id}"]`)?.remove();
  updateUI();
}

function updateUI() {
  const repeated = getRepeated();
  document.querySelectorAll('#tbody tr').forEach(tr => {
    const refInput = tr.querySelector('.col-ref');
    const tag = tr.querySelector('.repeated-tag');
    const ref = refInput.value.trim().toUpperCase();
    const isRep = repeated.has(ref);
    ['col-item','col-ref','col-desc','col-cant'].forEach(c =>
      tr.querySelector(`.${c}`)?.classList.toggle('repeated', isRep)
    );
    tag.style.display = isRep ? 'inline' : 'none';
    if (isRep) {
      const cnt = [...document.querySelectorAll('.col-ref')]
        .filter(i => i.value.trim().toUpperCase() === ref).length;
      tag.textContent = `√ó${cnt}`;
    }
  });

  const rows = [...document.querySelectorAll('#tbody tr')].map(tr => ({
    ref: tr.querySelector('.col-ref').value.trim(),
    cant: parseInt(tr.querySelector('.col-cant').value) || 0,
  })).filter(r => r.ref);

  const total = rows.reduce((s, r) => s + r.cant, 0);
  document.getElementById('infoBar').innerHTML = `
    <span><span class="dot"></span>${rows.length} √≠tem${rows.length !== 1 ? 's' : ''}</span>
    <span>Total: ${total} unidades</span>
    ${repeated.size ? `<span><span class="dot warn"></span>${repeated.size} ref${repeated.size !== 1 ? 's' : ''} repetida${repeated.size !== 1 ? 's' : ''}</span>` : ''}
  `;
}

function clearAll() {
  if (!confirm('¬øLimpiar todos los √≠tems?')) return;
  document.getElementById('tbody').innerHTML = '';
  updateUI();
}

// ‚îÄ‚îÄ Export Excel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportExcel() {
  const rows = [...document.querySelectorAll('#tbody tr')].map(tr => ({
    item: tr.querySelector('.col-item').value.trim(),
    ref:  tr.querySelector('.col-ref').value.trim().toUpperCase(),
    desc: tr.querySelector('.col-desc').value.trim(),
    cant: parseInt(tr.querySelector('.col-cant').value) || 0,
  })).filter(r => r.ref || r.desc || r.item);

  if (!rows.length) { alert('Agreg√° al menos un √≠tem.'); return; }

  const repeated = getRepeated();
  const nro     = document.getElementById('nroRemito').value || 'SIN-NUMERO';
  const fecha   = document.getElementById('fecha').value || '';
  const cliente = document.getElementById('cliente').value || '';
  const pedido  = document.getElementById('nroPedido').value || '';

  const wb = XLSX.utils.book_new();
  const wsData = [
    [`REMITO N¬∞ ${nro} ¬∑ ${cliente} ¬∑ ${fecha}`],
    [`N¬∞ Pedido: ${pedido}`],
    [],
    ['Item', 'Referencia', 'Descripci√≥n', 'Cantidad'],
    ...rows.map(r => [r.item, r.ref, r.desc, r.cant])
  ];
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  ws['!cols'] = [{ wch: 10 }, { wch: 18 }, { wch: 55 }, { wch: 12 }];
  ws['!merges'] = [{ s:{r:0,c:0}, e:{r:0,c:3} }];
  rows.forEach((r, i) => {
    if (repeated.has(r.ref)) {
      ['A','B','C','D'].forEach(col => {
        const addr = `${col}${5+i}`;
        if (ws[addr]) ws[addr].s = { font: { color: { rgb: 'CC0000' }, bold: true } };
      });
    }
  });
  XLSX.utils.book_append_sheet(wb, ws, `Remito ${nro}`.slice(0,31));
  XLSX.writeFile(wb, `Remito_${nro.replace(/[^a-zA-Z0-9]/g,'_')}.xlsx`);

  const t = document.getElementById('toast');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// Init
document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
addRow();
</script>
</body>
</html>
