<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Remitos ‚Üí Excel ¬∑ OCR Local</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<!-- Tesseract.js -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --bg: #0d0f14;
    --surface: #161920;
    --surface2: #1e2230;
    --border: #2a2f40;
    --accent: #7c3aed;
    --accent2: #a78bfa;
    --danger: #ef4444;
    --danger-soft: #2d1515;
    --text: #e2e8f0;
    --text-muted: #64748b;
    --text-dim: #94a3b8;
    --green: #22c55e;
    --green-soft: #0f2d1a;
    --radius: 10px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Syne', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: linear-gradient(rgba(124,58,237,0.04) 1px, transparent 1px), linear-gradient(90deg, rgba(124,58,237,0.04) 1px, transparent 1px);
    background-size: 40px 40px; pointer-events: none; z-index: 0;
  }
  .container { max-width: 1020px; margin: 0 auto; padding: 40px 24px 80px; position: relative; z-index: 1; }

  header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 40px; flex-wrap: wrap; gap: 16px; }
  .logo-area h1 { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; }
  .logo-area h1 span { color: var(--accent2); }
  .logo-area p { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-muted); margin-top: 6px; letter-spacing: 0.05em; text-transform: uppercase; }
  .badge { font-family: 'DM Mono', monospace; font-size: 10px; background: rgba(124,58,237,0.12); color: var(--accent2); border: 1px solid rgba(124,58,237,0.3); padding: 4px 10px; border-radius: 20px; letter-spacing: 0.05em; align-self: flex-start; }

  .section { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 28px; margin-bottom: 20px; }
  .section-title { font-size: 11px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
  .section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  .notice { background: rgba(124,58,237,0.07); border: 1px solid rgba(124,58,237,0.2); border-radius: 8px; padding: 12px 16px; font-family: 'DM Mono', monospace; font-size: 11px; color: var(--accent2); margin-bottom: 16px; line-height: 1.7; }

  .dropzone { border: 2px dashed var(--border); border-radius: var(--radius); padding: 48px 24px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; }
  .dropzone:hover, .dropzone.drag { border-color: var(--accent); background: rgba(124,58,237,0.04); }
  .dropzone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
  .dropzone-icon { font-size: 36px; margin-bottom: 12px; }
  .dropzone h3 { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
  .dropzone p { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-muted); }
  .file-selected { border-color: var(--green) !important; background: var(--green-soft) !important; }

  .analyze-wrap { display: flex; justify-content: center; margin-top: 20px; }

  /* Progress */
  .progress-wrap { margin-top: 20px; display: none; }
  .progress-wrap.show { display: block; }
  .progress-label { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--accent2); margin-bottom: 8px; display: flex; justify-content: space-between; }
  .progress-bar-bg { background: var(--surface2); border-radius: 20px; height: 6px; overflow: hidden; }
  .progress-bar { background: linear-gradient(90deg, var(--accent), var(--accent2)); height: 100%; border-radius: 20px; transition: width 0.3s; width: 0%; }

  .status-bar { display: none; align-items: center; gap: 12px; padding: 14px 18px; border-radius: 8px; font-family: 'DM Mono', monospace; font-size: 12px; margin-top: 16px; }
  .status-bar.loading { background: rgba(124,58,237,0.08); border: 1px solid rgba(124,58,237,0.2); color: var(--accent2); display: flex; }
  .status-bar.success { background: var(--green-soft); border: 1px solid rgba(34,197,94,0.25); color: var(--green); display: flex; }
  .status-bar.error { background: var(--danger-soft); border: 1px solid rgba(239,68,68,0.25); color: var(--danger); display: flex; }
  .spinner { width: 14px; height: 14px; border: 2px solid rgba(124,58,237,0.3); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; flex-shrink: 0; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Debug text */
  .debug-wrap { margin-top: 16px; display: none; }
  .debug-wrap.show { display: block; }
  .debug-wrap summary { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-muted); cursor: pointer; padding: 8px 0; }
  .debug-wrap summary:hover { color: var(--accent2); }
  .debug-text { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 12px; font-family: 'DM Mono', monospace; font-size: 10px; color: var(--text-muted); max-height: 200px; overflow-y: auto; white-space: pre-wrap; margin-top: 8px; line-height: 1.5; }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group label { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-muted); letter-spacing: 0.05em; text-transform: uppercase; }
  .form-group input { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 13px; padding: 10px 14px; outline: none; transition: border-color 0.15s; width: 100%; }
  .form-group input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(124,58,237,0.1); }
  .form-group input::placeholder { color: var(--text-muted); }

  .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead th { background: var(--surface2); font-family: 'DM Mono', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); padding: 12px 14px; text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap; }
  tbody tr { border-bottom: 1px solid rgba(42,47,64,0.6); transition: background 0.1s; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: rgba(255,255,255,0.02); }
  tbody td { padding: 4px 6px; vertical-align: middle; }
  tbody td input { background: transparent; border: 1px solid transparent; border-radius: 5px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 12px; padding: 7px 10px; width: 100%; outline: none; transition: all 0.15s; }
  tbody td input:focus { background: var(--surface2); border-color: var(--accent); }
  tbody td input.repeated { color: var(--danger); font-weight: 500; }
  .repeated-tag { font-family: 'DM Mono', monospace; font-size: 9px; background: var(--danger-soft); color: var(--danger); border: 1px solid rgba(239,68,68,0.3); padding: 2px 6px; border-radius: 20px; margin-left: 4px; white-space: nowrap; }
  .btn-remove { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; padding: 6px 10px; border-radius: 5px; transition: all 0.15s; line-height: 1; }
  .btn-remove:hover { color: var(--danger); background: var(--danger-soft); }

  .actions { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px; align-items: center; }
  .btn { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; padding: 11px 22px; border-radius: 8px; border: none; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 8px; letter-spacing: 0.02em; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover:not(:disabled) { background: #6d28d9; transform: translateY(-1px); box-shadow: 0 4px 20px rgba(124,58,237,0.4); }
  .btn-secondary { background: var(--surface2); color: var(--text-dim); border: 1px solid var(--border); }
  .btn-secondary:hover:not(:disabled) { border-color: var(--accent); color: var(--accent2); }
  .btn-ghost { background: none; color: var(--text-muted); border: 1px dashed var(--border); }
  .btn-ghost:hover:not(:disabled) { border-color: var(--accent); color: var(--accent2); background: rgba(124,58,237,0.05); }
  .btn-export { background: var(--green); color: #000; font-weight: 800; }
  .btn-export:hover:not(:disabled) { background: #16a34a; transform: translateY(-1px); box-shadow: 0 4px 20px rgba(34,197,94,0.35); }

  .info-bar { display: flex; gap: 24px; flex-wrap: wrap; font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-muted); margin-top: 12px; }
  .info-bar span { display: flex; align-items: center; gap: 6px; }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); display: inline-block; }
  .dot.warn { background: var(--danger); }

  #toast { position: fixed; bottom: 32px; right: 32px; background: var(--green); color: #000; font-family: 'DM Mono', monospace; font-size: 12px; font-weight: 500; padding: 12px 20px; border-radius: 8px; opacity: 0; transform: translateY(10px); transition: all 0.3s; z-index: 999; pointer-events: none; }
  #toast.show { opacity: 1; transform: translateY(0); }

  @media (max-width: 600px) {
    .form-row { grid-template-columns: 1fr; }
    .actions { flex-direction: column; }
    .btn { width: 100%; justify-content: center; }
  }
</style>
</head>
<body>
<div class="container">

  <header>
    <div class="logo-area">
      <h1>Remitos ‚Üí <span>Excel</span> ¬∑ OCR</h1>
      <p>OCR local ¬∑ Sin internet ¬∑ Sin APIs ¬∑ 100% gratis</p>
    </div>
    <div class="badge">LOCAL ¬∑ SIN SERVIDOR</div>
  </header>

  <!-- Upload -->
  <div class="section">
    <div class="section-title">Cargar PDF Escaneado</div>
    <div class="notice">
      ‚ö° Todo corre en tu navegador. El PDF nunca sale de tu PC.<br>
      ‚è± PDFs escaneados tardan ~20-40 segundos por p√°gina (OCR local con Tesseract.js).<br>
      ‚úèÔ∏è Pod√©s corregir cualquier dato en la tabla antes de exportar.
    </div>
    <div class="dropzone" id="dropzone">
      <input type="file" accept=".pdf,image/*" id="fileInput" onchange="onFileSelected(this)">
      <div class="dropzone-icon" id="dzIcon">üìÑ</div>
      <h3 id="dropTitle">Arrastr√° el PDF o hac√© click</h3>
      <p id="dropSub">PDF escaneado o imagen del remito</p>
    </div>

    <div class="analyze-wrap">
      <button class="btn btn-primary" id="btnAnalyze" onclick="analizarDocumento()" disabled>
        ‚óâ Leer con OCR
      </button>
    </div>

    <div class="progress-wrap" id="progressWrap">
      <div class="progress-label">
        <span id="progressLabel">Iniciando...</span>
        <span id="progressPct">0%</span>
      </div>
      <div class="progress-bar-bg">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>

    <div class="status-bar" id="statusBar">
      <div class="spinner" id="statusSpinner"></div>
      <span id="statusText"></span>
    </div>

    <div class="debug-wrap" id="debugWrap">
      <details>
        <summary>üîç Ver texto extra√≠do por OCR (para debug)</summary>
        <div class="debug-text" id="debugText"></div>
      </details>
    </div>
  </div>

  <!-- Datos -->
  <div class="section">
    <div class="section-title">Datos del Documento</div>
    <div class="form-row">
      <div class="form-group">
        <label>N√∫mero de Remito</label>
        <input id="nroRemito" type="text" placeholder="0044-00233640">
      </div>
      <div class="form-group">
        <label>Fecha</label>
        <input id="fecha" type="date">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Cliente</label>
        <input id="cliente" type="text" placeholder="BAGNOLS S.A.">
      </div>
      <div class="form-group">
        <label>N¬∞ Pedido Cliente</label>
        <input id="nroPedido" type="text" placeholder="I 133/25-RAMSAY">
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="section">
    <div class="section-title">√çtems</div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th style="width:80px">Item</th>
            <th style="width:160px">Referencia</th>
            <th>Descripci√≥n</th>
            <th style="width:90px">Cantidad</th>
            <th style="width:40px"></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="actions">
      <button class="btn btn-ghost" onclick="addRow()">Ôºã Agregar fila</button>
      <button class="btn btn-secondary" onclick="clearAll()">‚úï Limpiar</button>
    </div>
    <div class="info-bar" id="infoBar"></div>
  </div>

  <div class="actions">
    <button class="btn btn-export" onclick="exportExcel()">‚Üì Descargar Excel</button>
  </div>

</div>
<div id="toast">‚úì Excel generado correctamente</div>

<script>
// Setup PDF.js worker
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let rowId = 0;
let selectedFile = null;

// ‚îÄ‚îÄ File selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onFileSelected(input) {
  const file = input.files[0];
  if (!file) return;
  selectedFile = file;
  document.getElementById('dropzone').classList.add('file-selected');
  document.getElementById('dzIcon').textContent = '‚úÖ';
  document.getElementById('dropTitle').textContent = file.name;
  document.getElementById('dropSub').textContent = `${(file.size/1024).toFixed(1)} KB ¬∑ listo para OCR`;
  document.getElementById('btnAnalyze').disabled = false;
}

const dz = document.getElementById('dropzone');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag'); });
dz.addEventListener('dragleave', () => dz.classList.remove('drag'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('drag');
  const file = e.dataTransfer.files[0];
  if (!file) return;
  const dt = new DataTransfer(); dt.items.add(file);
  document.getElementById('fileInput').files = dt.files;
  onFileSelected(document.getElementById('fileInput'));
});

// ‚îÄ‚îÄ Progress ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setProgress(pct, label) {
  document.getElementById('progressWrap').classList.add('show');
  document.getElementById('progressBar').style.width = pct + '%';
  document.getElementById('progressPct').textContent = Math.round(pct) + '%';
  document.getElementById('progressLabel').textContent = label;
}

function showStatus(type, msg) {
  const bar = document.getElementById('statusBar');
  bar.className = `status-bar ${type}`;
  document.getElementById('statusSpinner').style.display = type === 'loading' ? 'block' : 'none';
  document.getElementById('statusText').textContent = msg;
}

// ‚îÄ‚îÄ PDF ‚Üí Canvas ‚Üí OCR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function pdfPageToCanvas(page, scale = 3.0) {
  const viewport = page.getViewport({ scale });
  const canvas = document.createElement('canvas');
  canvas.width = viewport.width;
  canvas.height = viewport.height;
  const ctx = canvas.getContext('2d');

  // Fondo blanco
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  await page.render({ canvasContext: ctx, viewport }).promise;
  return canvas;
}

async function ocrCanvas(canvas, pageNum, totalPages) {
  const worker = await Tesseract.createWorker('spa+eng', 1, {
    logger: m => {
      if (m.status === 'recognizing text') {
        const base = ((pageNum - 1) / totalPages) * 100;
        const step = (1 / totalPages) * 100;
        setProgress(base + m.progress * step, `OCR p√°gina ${pageNum}/${totalPages}...`);
      }
    }
  });

  await worker.setParameters({
    tessedit_pageseg_mode: '6',   // bloque uniforme de texto
  });

  const { data: { text } } = await worker.recognize(canvas);
  await worker.terminate();
  return text;
}

// ‚îÄ‚îÄ Main analyzer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function analizarDocumento() {
  if (!selectedFile) return;
  document.getElementById('btnAnalyze').disabled = true;
  document.getElementById('progressWrap').classList.add('show');
  document.getElementById('debugWrap').classList.remove('show');
  showStatus('loading', 'Cargando PDF...');

  try {
    let textoTotal = '';

    if (selectedFile.type === 'application/pdf') {
      // PDF ‚Üí extraer p√°ginas
      const arrayBuffer = await selectedFile.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      const totalPages = pdf.numPages;

      for (let p = 1; p <= totalPages; p++) {
        setProgress(((p-1)/totalPages)*100, `Renderizando p√°gina ${p}/${totalPages}...`);
        const page = await pdf.getPage(p);

        // Intentar extraer texto digital primero
        const textContent = await page.getTextContent();
        const textoDigital = textContent.items.map(i => i.str).join(' ');

        if (textoDigital.trim().length > 100) {
          // PDF digital ‚Äî usar texto directo
          textoTotal += textoDigital + '\n';
          setProgress((p/totalPages)*100, `Texto extra√≠do (digital) p√°gina ${p}`);
        } else {
          // PDF escaneado ‚Äî usar OCR
          const canvas = await pdfPageToCanvas(page, 3.0);
          const texto = await ocrCanvas(canvas, p, totalPages);
          textoTotal += texto + '\n';
        }
      }
    } else {
      // Imagen directa
      setProgress(10, 'Procesando imagen...');
      const imgUrl = URL.createObjectURL(selectedFile);
      const img = new Image();
      await new Promise(r => { img.onload = r; img.src = imgUrl; });

      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0);

      const texto = await ocrCanvas(canvas, 1, 1);
      textoTotal = texto;
    }

    // Mostrar texto para debug
    document.getElementById('debugText').textContent = textoTotal;
    document.getElementById('debugWrap').classList.add('show');

    setProgress(95, 'Extrayendo datos...');

    // Parsear datos
    const datos = parsearTexto(textoTotal);

    // Llenar formulario
    if (datos.nroRemito) document.getElementById('nroRemito').value = datos.nroRemito;
    if (datos.fecha)     document.getElementById('fecha').value = datos.fecha;
    if (datos.cliente)   document.getElementById('cliente').value = datos.cliente;
    if (datos.nroPedido) document.getElementById('nroPedido').value = datos.nroPedido;

    // Llenar tabla
    document.getElementById('tbody').innerHTML = '';
    rowId = 0;
    datos.items.forEach(it => addRow(it));

    setProgress(100, 'Completado');
    showStatus('success', `‚úì ${datos.items.length} √≠tems extra√≠dos. Revis√° y correg√≠ si es necesario.`);

  } catch(err) {
    showStatus('error', `‚úó Error: ${err.message}`);
    console.error(err);
  } finally {
    document.getElementById('btnAnalyze').disabled = false;
  }
}

// ‚îÄ‚îÄ Parser de texto OCR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parsearTexto(texto) {
  const lineas = texto.split('\n').map(l => l.trim()).filter(l => l.length > 0);

  // N√∫mero de remito
  let nroRemito = '';
  const mNro = texto.match(/N[¬∞o0¬∫]\s*(\d{4}-\d{8})/i) || texto.match(/(\d{4}-\d{8})/);
  if (mNro) nroRemito = mNro[1];

  // Fecha
  let fecha = new Date().toISOString().split('T')[0];
  const mFecha = texto.match(/FECHA[:\s]*(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4})/i)
               || texto.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4})/);
  if (mFecha) {
    const p = mFecha[1].split(/[\/\-]/);
    if (p.length === 3) fecha = `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
  }

  // Cliente
  let cliente = '';
  const mCliente = texto.match(/(?:Se[√±n]or[ae]?s?|CLIENTE)[:\s]*\n?([A-Z√Å√â√ç√ì√ö][A-Z√Å√â√ç√ì√ö\s\.]{3,40}S\.A\.)/i);
  if (mCliente) cliente = mCliente[1].trim();
  if (!cliente) {
    const mBagnols = texto.match(/(BAGNOLS\s+S\.?A\.?)/i);
    if (mBagnols) cliente = mBagnols[1].trim();
  }

  // N√∫mero de pedido
  let nroPedido = '';
  const mPed = texto.match(/(?:Ped(?:ido)?\.?\s*N[¬∞o]?:?\s*)(\d{9,})/i);
  if (mPed) nroPedido = mPed[1];

  // ‚îÄ‚îÄ √çtems ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const items = [];
  const excluir = ['PED','DESP','FECHA','COND','IVA','PESO','BULTO','FLETE','SCH','SIGN'];

  // Patr√≥n principal: √≠tem (m√∫ltiplo de 10) + referencia + descripci√≥n + cantidad
  // Ejemplo: "10 28958 2 CUBREBORNES 3/4P (INS100/160) 1"
  const patronItem = /^\s*(\d{1,3}0)\s+([A-Z0-9][A-Z0-9\-]{2,18})\s+(.{8,70?})\s+(\d{1,4})\s*$/;
  const patronFlex = /^\s*(\d{1,3}0)\s+([A-Z0-9][A-Z0-9\-]{2,18})\s+(.+)/;

  for (let i = 0; i < lineas.length; i++) {
    const linea = lineas[i];

    // Patr√≥n completo con cantidad al final
    let m = linea.match(patronItem);
    if (m) {
      const ref = m[2].trim();
      if (!excluir.some(e => ref.startsWith(e))) {
        items.push({ item: m[1], ref, desc: limpiarDesc(m[3]), cant: parseInt(m[4]) });
        continue;
      }
    }

    // Patr√≥n flexible
    m = linea.match(patronFlex);
    if (m) {
      const ref = m[2].trim();
      if (excluir.some(e => ref.startsWith(e))) continue;
      if (ref.length < 4) continue;

      let desc = m[3].trim();
      let cant = 1;

      // Cantidad al final de la descripci√≥n
      const mCant = desc.match(/^(.*?)\s+(\d{1,4})\s*$/);
      if (mCant) {
        desc = mCant[1].trim();
        cant = parseInt(mCant[2]);
      } else if (i + 1 < lineas.length) {
        // Cantidad en l√≠nea siguiente
        const mNext = lineas[i+1].match(/^\s*(\d{1,4})\s*$/);
        if (mNext) { cant = parseInt(mNext[1]); i++; }
      }

      items.push({ item: m[1], ref, desc: limpiarDesc(desc), cant });
    }
  }

  return { nroRemito, fecha, cliente, nroPedido, items };
}

function limpiarDesc(desc) {
  return desc.replace(/[|\\{}\[\]<>]/g, '').replace(/\s+/g, ' ').trim();
}

// ‚îÄ‚îÄ Table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getRepeated() {
  const count = {};
  document.querySelectorAll('.col-ref').forEach(i => {
    const v = i.value.trim().toUpperCase();
    if (v) count[v] = (count[v] || 0) + 1;
  });
  return new Set(Object.keys(count).filter(k => count[k] > 1));
}

function addRow(data = {}) {
  const id = rowId++;
  const tr = document.createElement('tr');
  tr.dataset.id = id;
  tr.innerHTML = `
    <td><input class="col-item" placeholder="10" value="${data.item ?? ''}"></td>
    <td style="white-space:nowrap">
      <input class="col-ref" placeholder="REF" value="${data.ref ?? ''}" oninput="updateUI()">
      <span class="repeated-tag" style="display:none"></span>
    </td>
    <td><input class="col-desc" placeholder="Descripci√≥n" value="${data.desc ?? ''}"></td>
    <td><input class="col-cant" type="number" min="0" placeholder="1" value="${data.cant ?? ''}"></td>
    <td><button class="btn-remove" onclick="removeRow(${id})">√ó</button></td>
  `;
  document.getElementById('tbody').appendChild(tr);
  updateUI();
}

function removeRow(id) {
  document.querySelector(`tr[data-id="${id}"]`)?.remove();
  updateUI();
}

function updateUI() {
  const repeated = getRepeated();
  document.querySelectorAll('#tbody tr').forEach(tr => {
    const refInput = tr.querySelector('.col-ref');
    const tag = tr.querySelector('.repeated-tag');
    const ref = refInput.value.trim().toUpperCase();
    const isRep = repeated.has(ref);
    ['col-item','col-ref','col-desc','col-cant'].forEach(c =>
      tr.querySelector(`.${c}`)?.classList.toggle('repeated', isRep)
    );
    tag.style.display = isRep ? 'inline' : 'none';
    if (isRep) {
      const cnt = [...document.querySelectorAll('.col-ref')]
        .filter(i => i.value.trim().toUpperCase() === ref).length;
      tag.textContent = `√ó${cnt}`;
    }
  });

  const rows = [...document.querySelectorAll('#tbody tr')].map(tr => ({
    ref: tr.querySelector('.col-ref').value.trim(),
    cant: parseInt(tr.querySelector('.col-cant').value) || 0,
  })).filter(r => r.ref);

  const total = rows.reduce((s, r) => s + r.cant, 0);
  document.getElementById('infoBar').innerHTML = `
    <span><span class="dot"></span>${rows.length} √≠tem${rows.length !== 1 ? 's' : ''}</span>
    <span>Total: ${total} unidades</span>
    ${repeated.size ? `<span><span class="dot warn"></span>${repeated.size} ref${repeated.size !== 1 ? 's' : ''} repetida${repeated.size !== 1 ? 's' : ''}</span>` : ''}
  `;
}

function clearAll() {
  if (!confirm('¬øLimpiar todos los √≠tems?')) return;
  document.getElementById('tbody').innerHTML = '';
  updateUI();
}

// ‚îÄ‚îÄ Export Excel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportExcel() {
  const rows = [...document.querySelectorAll('#tbody tr')].map(tr => ({
    item: tr.querySelector('.col-item').value.trim(),
    ref:  tr.querySelector('.col-ref').value.trim().toUpperCase(),
    desc: tr.querySelector('.col-desc').value.trim(),
    cant: parseInt(tr.querySelector('.col-cant').value) || 0,
  })).filter(r => r.ref || r.desc || r.item);

  if (!rows.length) { alert('Agreg√° al menos un √≠tem.'); return; }

  const repeated = getRepeated();
  const nro     = document.getElementById('nroRemito').value || 'SIN-NUMERO';
  const fecha   = document.getElementById('fecha').value || '';
  const cliente = document.getElementById('cliente').value || '';
  const pedido  = document.getElementById('nroPedido').value || '';

  const wb = XLSX.utils.book_new();
  const wsData = [
    [`REMITO N¬∞ ${nro} ¬∑ ${cliente} ¬∑ ${fecha}`],
    [`N¬∞ Pedido: ${pedido}`],
    [],
    ['Item', 'Referencia', 'Descripci√≥n', 'Cantidad'],
    ...rows.map(r => [r.item, r.ref, r.desc, r.cant])
  ];
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  ws['!cols'] = [{ wch: 10 }, { wch: 18 }, { wch: 55 }, { wch: 12 }];
  ws['!merges'] = [{ s:{r:0,c:0}, e:{r:0,c:3} }];
  rows.forEach((r, i) => {
    if (repeated.has(r.ref)) {
      ['A','B','C','D'].forEach(col => {
        const addr = `${col}${5+i}`;
        if (ws[addr]) ws[addr].s = { font: { color: { rgb: 'CC0000' }, bold: true } };
      });
    }
  });
  XLSX.utils.book_append_sheet(wb, ws, `Remito ${nro}`.slice(0,31));
  XLSX.writeFile(wb, `Remito_${nro.replace(/[^a-zA-Z0-9]/g,'_')}.xlsx`);

  const t = document.getElementById('toast');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// Init
document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
addRow();
</script>
</body>
</html>
